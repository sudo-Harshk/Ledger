rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }
    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    function hasUserDocument() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    function isTeacher() {
      return isSignedIn() && hasUserDocument() && getRole() == 'teacher';
    }
    function isAdmin() {
      return isSignedIn() && hasUserDocument() && getRole() == 'admin';
    }
    function isStudent() {
      return isSignedIn() && hasUserDocument() && getRole() == 'student';
    }
    function isTeacherOrAdmin() {
      return isSignedIn() && hasUserDocument() && (getRole() == 'teacher' || getRole() == 'admin');
    }
    function isValidUserUpdate() {
      let protectedFields = ['role','monthlyFee','totalDueByMonth','lastTotalDueUpdate','isActive'].toSet();
      let changed = request.resource.data.diff(resource.data).affectedKeys();
      return !changed.hasAny(protectedFields);
    }

    match /users/{userId} {
      
      allow read: if isSignedIn() && request.auth.uid == userId;
      
      allow read: if isSignedIn() 
                    && request.auth.uid != userId 
                    && isTeacherOrAdmin();
      
      allow list: if isTeacherOrAdmin(); 

      allow create: if isSignedIn() && (isTeacherOrAdmin() || request.auth.uid == userId);

      allow update: if isSignedIn() && (
        (request.auth.uid == userId && isValidUserUpdate())
        ||
        isTeacherOrAdmin()
      );

      allow delete: if isTeacherOrAdmin();

      match /monthlySummaries/{monthId} {
        allow read: if isSignedIn() && (request.auth.uid == userId || isTeacherOrAdmin());
        allow list: if isSignedIn() && (request.auth.uid == userId || isTeacherOrAdmin());
        allow write: if isTeacherOrAdmin();
      }
    }

    match /attendance/{attendanceId} {
      
      function isStudentActive() {
        let studentDoc = get(/databases/$(database)/documents/users/$(request.resource.data.studentId));
        return studentDoc.data.isActive != false;
      }
      
      allow read: if isSignedIn() && (request.auth.uid == resource.data.studentId || isTeacherOrAdmin());

      allow list: if isSignedIn();

      allow create: if (isSignedIn() && (
        (request.auth.uid == request.resource.data.studentId && request.resource.data.status == 'pending' && isStudentActive())
        || isTeacherOrAdmin()
      ));

      allow update: if isSignedIn() && isTeacherOrAdmin();
      allow delete: if isSignedIn() && isTeacherOrAdmin();
    }
    
    match /revenueSummaries/{summaryId} {
        allow read: if isSignedIn();
        allow list: if isSignedIn();
        allow write: if isSignedIn() && isTeacherOrAdmin();
    }

    match /platformMonthlyAttendance/{monthId} {
      allow read: if isSignedIn();
      allow list: if isSignedIn();
      allow write: if isTeacherOrAdmin();
    }

    match /platformMonthlyRevenue/{monthId} {
      allow read: if isSignedIn();
      allow list: if isSignedIn();
      allow write: if isTeacherOrAdmin();
    }

    match /{path=**}/monthlySummaries/{monthId} {
      allow read: if isSignedIn() && isTeacherOrAdmin();
      allow list: if isSignedIn() && isTeacherOrAdmin();
    }
  }
}
